---
title: "ccc"
author: "Pierre Nouvellet"
date: "2019-07"
---

```{r options, include = FALSE, message = FALSE, warning = FALSE, error = FALSE}
library(knitr)
library(Hmisc)
library(EpiEstim)
library(zoo)

opts_chunk$set(collapse = TRUE)

opts_chunk$set(fig.path='figs/', fig.keep='high', 
               dev=c('png'), fig.width=9, fig.height=6, cache=FALSE,
               tidy=FALSE, warning=FALSE, fig.show="asis"
 	       )

```

# input data

## Epi data

```{r}

d <- readRDS(file='../covid19-short-term-forcasts/Team.input/data_2020-04-12.rds')

country <- as.character(d$Country)



```


## Mobility

load and clean mobility data.

```{r, echo = FALSE}

d_m <- read.csv(file='Rdata/mobility/applemobilitytrends-2020-04-13.csv',stringsAsFactors = FALSE)
# d_m$region <- as.character(pop_size$Country.Name)#clean

#miss-spelled
# country[-which(as.character(country) %in% as.character(d_m$region))]


#corrections
d_m$region[which(d_m$region %in% 'Czech Republic')] <- 'Czechia'
d_m$region[which(d_m$region %in% 'UK')] <- 'United_Kingdom'
d_m$region[which(d_m$region %in% 'United States')] <- 'United_States_of_America'

# check
if (length(country[-which(country %in% d_m$region)])>0){
  print('warning')
  country[-which(country %in% d_m$region)]
}

# include country with data in both
f1 <- which(country %in% d_m$region)
f2 <- which(d_m$region %in% country)

d_m <- d_m[f2,]

d$I_active_transmission <- d$I_active_transmission[,c(1,f1+1)]
d$D_active_transmission <- d$D_active_transmission[,c(1,f1+1)]
d$Country <- d$Country[f1]

# include dates with data in both
dates <- as.Date(substr(names(d_m[,-c(1:3)]),start = 2, stop = 11),format='%Y.%m.%d')
f1 <- which(d$I_active_transmission$dates %in% dates)
f2 <- which(dates %in% d$I_active_transmission$dates)

d_m <- d_m[,c(1,2,3,3+f2)]

d$I_active_transmission <- d$I_active_transmission[f1,]
d$D_active_transmission <- d$D_active_transmission[f1,]


# correct epi
D <- d$D_active_transmission
I <- d$I_active_transmission

cumD <- data.frame(D$dates,apply(D[,-1],2,cumsum))
cumI <- data.frame(I$dates,apply(I[,-1],2,cumsum))

N_geo <- ncol(D)-1
N_days <- nrow(D)
country <- as.character(d$Country)

```


## Reduced mobility matrix

load data (dots), get weekly average, interpolate between (blue line)

```{r, echo = FALSE}

dates <- as.Date(substr(names(d_m[,-c(1:3)]),start = 2, stop = 11),format='%Y.%m.%d')



n_day_m <- round(length(dates)/7)*7

dates <- dates[1:n_day_m]

mob <- data.frame(dates = dates,
                  matrix(NA,n_day_m,N_geo))
names(mob) <- c('dates',country)

mob2 <- data.frame(dates = dates,
                  matrix(NA,n_day_m,N_geo))
names(mob2) <- c('dates',country)
# mob3 <- data.frame(dates = dates,
#                   matrix(NA,n_day_m,N_geo))

layout(matrix(1:4,2,2))
for (i  in 1:N_geo){
  f <- which(d_m$region %in% country[i])
  m <- d_m[f,]
  x <- colSums(m[,-c(1:3)])
  mob[,i+1] <- x[1:n_day_m]
  mob[,i+1] <- mob[,i+1] 
  # plot(x,main = country[i])
  
  x2 <- rowSums(matrix(mob[,i+1],n_day_m/7,7,by = TRUE))/7
  mob2[4+seq(1,(n_day_m/7)*7,by=7),i+1] <- x2
  mob2[,i+1] <- na.approx(mob2[,i+1],rule = 2)
  
  # rescaling
  max_mob <- max(mob2[,i+1])
  mob2[,i+1] <- mob2[,i+1]/max_mob
  mob[,i+1] <- mob[,i+1]/max_mob
  
  
  # mob3[4+seq(1,(n_day_m/7)*7,by=7),i+1] <- x2
  # mob3[,i+1] <- na.spline(mob3[,i+1])
  
  plot(mob$dates,mob[,i+1],main = country[i],#ylim = c(0,1),
       xlab = '',ylab = 'prop. mobility')
  lines(mob$dates,mob2[,i+1],col='blue')
  # lines(mob3[,i+1],col='red')
  abline(h=1,lwd=2,col='red',lty=2)
}



```



## Epi data

load Epi data and serial interval
```{r, echo = FALSE}


# serial interval
SI_gamma_dist_EpiEstim <-function(mu,si_std,SItrunc){
  SI_Distr <- EpiEstim::discr_si(seq(0, SItrunc), mu, si_std) # sapply(0:SItrunc, function(e) EpiEstim::DiscrSI(e,mu,mu*cv) )
  SI_Distr <- SI_Distr / sum(SI_Distr)
  return(list(dist = SI_Distr, SItrunc = SItrunc))
}


## # serial interval estimate used: mean = 3.96, sd =  4.75
## # Teunis et al.
SI <- SI_gamma_dist_EpiEstim(mu = d$si_mean[2], 
                             si_std  = d$si_std[2], 
                            SItrunc = 30)

plot(seq(0, SI$SItrunc), SI$dist, type = "h",
          lwd = 10, lend = 1, xlab = "time (days)", ylab = "frequency")
title(main = "Discrete distribution of the serial interval of COVID-19")



```

## delay infection to death

```{r, echo = FALSE}

## # serial interval estimate used: mean = 3.96, sd =  4.75
## # Teunis et al.
mu_id = 18.8
delta_id <- SI_gamma_dist_EpiEstim(mu = mu_id, 
                                 si_std  = .45*mu_id, 
                                 SItrunc = 50)

plot(seq(0, delta_id$SItrunc), delta_id$dist, type = "h",
          lwd = 10, lend = 1, xlab = "time (days)", ylab = "frequency")
title(main = "Discrete distribution of the delay infection to death")

sum(delta_id$dist[1:7])


```


## estimate Rt

get epiestim Rt estimates with 7 day time window.

```{r, echo = FALSE}

layout(matrix(1:6,3,2,byrow = TRUE))
t.window <- 7
R_epiest <- list()

for (i in 1:N_geo){
  
  obs <- D[,c(1,i+1)]

  epi_res <- EpiEstim::estimate_R(obs[,2],method = 'non_parametric_si',
                                  config = make_config(list(
                                    mean_prior = 1,
                                    si_distr = SI$dist, 
                                    t_start = seq(2,length(obs$date)-t.window+1,1), 
                                    t_end = seq(t.window+1,length(obs$date),1))))
  
  epi_res$R$t_end2 <-  obs$date[epi_res$R$t_end]
  # plot(epi_res$R$t_end,epi_res$R$`Median(R)`,
  #      # xlim=xlimp,
  #      ylim = c(0,4),
  #      type = 'l',col='black',lwd=2,bty = 'n',
  #      main = paste0(names(obs)[2]), xlab = '',ylab = 'Rt')
  # 
  # polygon(c(epi_res$R$t_end,rev(epi_res$R$t_end)),
  #         c(epi_res$R$`Quantile.0.975(R)`,rev(epi_res$R$`Quantile.0.025(R)`)), 
  #         col = rgb(0,0,0,.2), border = FALSE )
  # 
  # abline(h=1,lty = 2,lwd =2,col='red')
  
  # save R_last
  R_epiest[[i]] <- epi_res
}


```



## plot Rt against mobility

```{r, echo = FALSE}

xlim <- range(mob$dates)
layout(matrix(1:4,2,2,byrow = FALSE))

Rt_mob <- list()
for (i in 1:N_geo){
  
  epi_res <- R_epiest[[i]]$R
  
  cv_R <-  epi_res$`Std(R)`/ epi_res$`Mean(R)`
  f <- which(cv_R < .2)
  
  x <- (epi_res$t_end2 - mu_id)[f]
  epi_res$dates <- (epi_res$t_end2 - round(mu_id))
  plot(x,epi_res$`Median(R)`[f],
       xlim=xlim,
       ylim = c(0,4),
       type = 'l',col='black',lwd=2,bty = 'n',
       main =country[i], xlab = '',ylab = 'Rt')
  
  polygon(c(x,rev(x)),
          c(epi_res$`Quantile.0.975(R)`[f],rev(epi_res$`Quantile.0.025(R)`[f])), 
          col = rgb(0,0,0,.2), border = FALSE )
  
  
  ## 
  lines(mob$dates,mob[,i+1])
  lines(mob$dates,mob2[,i+1],col='blue')
  
  ## vs
  new <- merge(epi_res,mob2[,c(1,i+1)])
  cv_R <-  new$`Std(R)`/ new$`Mean(R)`
  f <- which(cv_R < .2)
  plot(c(10),c(10),main = country[i],
         xlab = 'Prop. reduction in movement',
         ylab = 'Rt',
         xlim = c(0,1)
       ,ylim = c(0,8))
  
  errbar(x = 1-new[f,ncol(new)],
         y = new$`Median(R)`[f],
         yplus = new$`Quantile.0.975(R)`[f],
         yminus = new$`Quantile.0.025(R)`[f],
         add=TRUE)
  abline(h=1,lwd=2,col='red',lty=2)
  
  Rt_mob[[i]] <- new
  
}
  

```


```{r, echo = FALSE}

xlim <- range(mob$dates)
layout(matrix(1:4,2,2,byrow = FALSE))
for (i in 1:N_geo){
  
  ## vs
  new <- Rt_mob[[i]]
  cv_R <-  new$`Std(R)`/ new$`Mean(R)`
  f <- which(cv_R < .2)
  plot(c(10),c(10),main = country[i],
       xlab = 'Prop. reduction in movement',
       ylab = 'Rt',
       xlim = c(0,1),
       ylim = c(log(0.5),log(8)))
  
  errbar(x = 1-new[f,ncol(new)],
         y = log(new$`Median(R)`[f]),
         yplus = log(new$`Quantile.0.975(R)`[f]),
         yminus = log(new$`Quantile.0.025(R)`[f]),
         add=TRUE)
  abline(h=log(1),lwd=2,col='red',lty=2)
  
}
  

```

# uk figure

```{r}
f <- which(country %in% 'United_Kingdom')




niceplot <- function(i){
layout(matrix(c(1,1,3,3,3,2,2,3,3,3),2,5,byrow = TRUE))
  # plot Rt
epi_res <- R_epiest[[i]]$R

cv_R <-  epi_res$`Std(R)`/ epi_res$`Mean(R)`
f <- which(cv_R < .2)

x <- (epi_res$t_end2 - mu_id)[f]
epi_res$dates <- (epi_res$t_end2 - round(mu_id))
plot(x,epi_res$`Median(R)`[f],
     xlim=xlim,
     ylim = c(0,8),
     type = 'l',col='black',lwd=2,bty = 'n',
     # main =country[i], 
     xlab = '',ylab = 'Rt')

polygon(c(x,rev(x)),
        c(epi_res$`Quantile.0.975(R)`[f],rev(epi_res$`Quantile.0.025(R)`[f])), 
        col = rgb(0,0,0,.2), border = FALSE )
abline(h=(1),lwd=2,col='red',lty=2)

# plot mobility
plot(mob$dates,mob[,i+1],main = country[i],#ylim = c(0,1),
     xlab = '',ylab = 'prop. mobility',pch=16,bty = 'n')
lines(mob$dates,mob2[,i+1],col='blue',lwd=2)
# lines(mob3[,i+1],col='red')
abline(h=1,lwd=2,col='red',lty=2)
  
# plot Rt vs mob
  
new <- Rt_mob[[i]]
cv_R <-  new$`Std(R)`/ new$`Mean(R)`
f <- which(cv_R < .2)

errbar(x = 1-new[f,ncol(new)],
       y = log(new$`Median(R)`[f]),
       yplus = log(new$`Quantile.0.975(R)`[f]),
       yminus = log(new$`Quantile.0.025(R)`[f]),
       xlab = 'Prop. reduction in movement',
       ylab = 'Rt',yaxt="n",
       xlim = c(0,1),bty = 'n',
       ylim = c(log(0.5),log(8)))
axis(side =2, at = log(c(0.5,1,2,4)), labels = c(0.5,1,2,4))


abline(h=log(1),lwd=2,col='red',lty=2)
}

niceplot(f)

```

# Inference

data used

```{r}


# delay corrction
m_w_delay <- matrix(0,nrow = N_days, ncol = N_days)
for (i in 1:N_days){
  f <- max(c(1,i-delta_id$SItrunc))
  m_w_delay[i,f:i] <- rev(delta_id$dist)[((delta_id$SItrunc+1)-(i-f)):(delta_id$SItrunc+1)]
  if (i>1) m_w_delay[i,f:i] <-  m_w_delay[i,f:i]/sum( m_w_delay[i,f:i])
}


# overall infectivity matrix
Ot <- matrix(NA, nrow = N_days, ncol = N_geo)
ws <- rev(SI$dist)
for (i in 1:N_days){
  f <- max(c(1,(i-SI$SItrunc)))
  Ot[i,] <- t(t(D[f:i,-1])%*%ws[((SI$SItrunc+1)-(i-f)):(SI$SItrunc+1)])
}
Ot <- data.frame(dates = D$dates,
                 Ot)
names(Ot) <- names(D)

# risk perception
M0 <- matrix(NA,nrow = N_days, ncol = N_days)
for (i in 1:N_days){
  M0[i, 1:i] <- seq(i-1,0)
}



```

## parameters check

```{r}
# epi
R0 <- 5

# sat
# malpha <- as.matrix(alpha)


# for risk
b <- 0.5


Rt_fun <- function(theta,x){
  # theta[1]/(1+exp(theta[3]*(x-theta[2])))
  exp(log(theta[1])-b*x)
}
plot(seq(0,1,.01),Rt_fun(theta = c(R0,b),x = seq(0,1,.01)))

# vectorised version
Rt_fun <- function(theta,x){
  R0 <- rep(1,nrow(x)) %*% t(theta[(1-1)*N_geo+ (1:N_geo)])
  # K <- rep(1,nrow(x)) %*% t(theta[(3-1)*N_geo+ (1:N_geo)])
  # X0 <- rep(1,nrow(x)) %*% t(theta[(2-1)*N_geo+ (1:N_geo)])
  B <- rep(1,nrow(x)) %*% t(theta[(2-1)*N_geo+ (1:N_geo)])

  res <- exp(log(R0)-B*(1-x))  #R0/(1+exp(K*(x-X0)))
  return(res)
}
```

others
```{r}
mD <- as.matrix(D[,-1])
# mI <- as.matrix(I[,-1])
# mcumI <- as.matrix(cumI[,-1])

mOt <- as.matrix(Ot[,-1])
for(i in 1:N_geo){
  mOt[ which( (D[,i+1]>0) & (mOt[,i] ==0 ) ),i] <-NA
}

mat_mob <- as.matrix(mob2[,-1])

# prior
theta0 <- c(rep(R0,N_geo),
            rep(b,N_geo))

# prior_theta <- matrix(NA,length(theta0),2)
prior_theta <- matrix(c(rep(c(0,10),N_geo),
                        rep(c(0,1e3),N_geo)),
                      length(theta0),2, byrow=TRUE)
# prior_theta <- matrix(c(rep(c(0,10),N_geo),
#                         rep(c(0,1),N_geo),
#                         rep(c(0,1e3),N_geo)),
#                       length(theta0),2, byrow=TRUE)


```


# Inference

```{r}
sapply(paste0('Rscript/mobility/',(list.files('Rscript/mobility/'))),FUN = source)
f0 <- function(x) paste0('R0_',x)
f1 <- function(x) paste0('x0_',x)
f2 <- function(x) paste0('k_sig_',x)
# theta0 <- c(R0, T_best, sigma_T, tau, h, mu_r, cv_r)
n_t<- c(sapply(country,f0), sapply(country,f1), sapply(country,f2))

sigma <- rep(1e-1,length(theta0))


 
 
```


```{r}
#check
rep <- 1e3
# res <- MCMC_iter(iter = rep, theta0 = theta0, s = sigma)
res <- MCMC_full(iter = rep, theta0 = theta0, s = sigma, repli_adapt = 10, within_iter = 1e2)

save.image(file = 'Rdata/check_mobility.RData')


```


# check convergence


```{r}
load(file = 'Rdata/check_mobility.RData')
Acc <- colSums(diff(res$theta)!=0)/(rep-1)
plot(res$logL[,1])
layout(matrix(1:4,2,2))
for (i in 1:length(theta0)){
  plot(res$theta[,i],
       main = paste0(n_t[i],' - ',round(Acc[i]*100)))#,       ylim = prior_theta[i,])
}
# 
# # for (i in 1:5){
#   plot(res$theta[1e3:rep,i],
#        main = paste0(n_t[i],' - ',round(Acc[i]*100)) )#,
#        # ylim = prior_theta[i,])
# }
```


# posterior relevant


```{r}

Rt_T <- array(NA,dim = c(N_days,N_geo,rep))

for (j in 1:rep){
 
  R_daily <- Rt_fun(theta = res$theta[j,], x = mat_mob )
  Rt_T[,,j] <- m_w_delay %*% R_daily
}

```


summaries

```{r}
temp <- data.frame(matrix(NA,N_days,N_geo))
summary_Rt <- list(dates = D$dates,
                   median = temp,
                   low = temp,
                   upper = temp)

for (i in 1:N_geo){
  temp <- apply(Rt_T[,i,],1,quantile,c(.5,.025,.975),na.rm = TRUE)
  # f <- which(D[,i+1]<2)
  # temp[,f] <- NA
  summary_Rt$median[,i] <- temp[1,]
  summary_Rt$low[,i] <- temp[2,]
  summary_Rt$upper[,i] <- temp[3,]
}
```

## posterior Rt vs. mobility

```{r}
n_d <- 1e2
Rt_v_mob <- array(NA,dim = c(n_d,N_geo,rep))
x= matrix(seq(0,1,length.out = n_d),n_d,N_geo,byrow = FALSE)

for (j in 1:rep){
 
  R_daily <- Rt_fun(theta = res$theta[j,], x = 1-x )
  # R_daily <- Rt_fun(theta = theta0, x = x )
  
  Rt_v_mob[,,j] <-  R_daily
}

```


```{r}
temp <- data.frame(matrix(NA,n_d,N_geo))
summary_R_mob <- list(mob = seq(0,1,length.out = n_d),
                   median = temp,
                   low = temp,
                   upper = temp)

for (i in 1:N_geo){
  temp <- apply(Rt_v_mob[,i,],1,quantile,c(.5,.025,.975),na.rm = TRUE)
  # f <- which(D[,i+1]<2)
  # temp[,f] <- NA
  summary_R_mob$median[,i] <- temp[1,]
  summary_R_mob$low[,i] <- temp[2,]
  summary_R_mob$upper[,i] <- temp[3,]
}

```


# plot Rt inferred and estimated



```{r}
epi_res <- R_epiest[[1]]$R
# delay corrction
m_w_delay2 <- matrix(0,nrow = nrow(epi_res), ncol = nrow(epi_res))
for (i in 1:nrow(epi_res)){
  f <- max(c(1,i-delta_id$SItrunc))
  m_w_delay2[i,f:i] <- rev(delta_id$dist)[((delta_id$SItrunc+1)-(i-f)):(delta_id$SItrunc+1)]
  if (i>1) m_w_delay2[i,f:i] <-  m_w_delay2[i,f:i]/sum( m_w_delay2[i,f:i])
}


niceplot <- function(i){
layout(matrix(c(1,1,3,3,3,2,2,3,3,3),2,5,byrow = TRUE))
# plot mobility
plot(mob$dates,mob[,i+1],#main = country[i],#ylim = c(0,1),
     xlab = '',ylab = 'prop. mobility',pch=16,bty = 'n')
lines(mob$dates,mob2[,i+1],col='blue',lwd=2)
# lines(mob3[,i+1],col='red')
abline(h=1,lwd=2,col='red',lty=2)


  # plot Rts over time
epi_res <- R_epiest[[i]]$R

cv_R <-  epi_res$`Std(R)`/ epi_res$`Mean(R)`
f <- which(cv_R < .2)


epi_res$dates <- (epi_res$t_end2 -3)#- round(mu_id))
x <- epi_res$dates[f] # (epi_res$t_end2 )[f]
plot(x,epi_res$`Median(R)`[f],
     xlim=xlim,
     ylim = c(0,8),
     type = 'l',col='black',lwd=2,bty = 'n',
     # main =country[i], 
     xlab = '',ylab = 'Rt')

polygon(c(x,rev(x)),
        c(epi_res$`Quantile.0.975(R)`[f],rev(epi_res$`Quantile.0.025(R)`[f])), 
        col = rgb(0,0,0,.2), border = FALSE )
abline(h=(1),lwd=2,col='red',lty=2)

# plot new estimates
f <- which(summary_Rt$median[,i] != 0)
lines(summary_Rt$dates[f],summary_Rt$median[f ,i],
       type='l',#ylim = c(0,10),
       # xlim=c(0,N_days),
       col='blue',lwd=2,
       main = country[i],ylab = 'R_t')
  
  polygon(c(summary_Rt$dates[f],rev(summary_Rt$dates[f])),
          c(summary_Rt$low[x[f],i],rev(summary_Rt$upper[x[f],i])),
          col=rgb(0,0,1,.2),border=NA)




  
# plot Rt vs mob
epi_res$dates <- (epi_res$t_end2)-3# - round(mu_id)) 
new <- merge(epi_res,mob2[,c(1,i+1)])
new[,ncol(new)] <- m_w_delay2 %*% as.vector(new[,ncol(new)])

cv_R <-  new$`Std(R)`/ new$`Mean(R)`
f <- which(cv_R < .2)



errbar(x = 1-new[f,ncol(new)],
       y = (new$`Median(R)`[f]),
       yplus = (new$`Quantile.0.975(R)`[f]),
       yminus = (new$`Quantile.0.025(R)`[f]),
       xlab = 'Prop. reduction in movement',
       ylab = 'Rt',yaxt="n",
       xlim = c(0,1),bty = 'n',
       ylim = c((0.5),(8)))
axis(side =2, at = (c(0,1,3,6)), labels = c(0,1,3,6))


abline(h=(1),lwd=2,col='red',lty=2)

lines(summary_R_mob$mob,(summary_R_mob$median[ ,i]),
       type='l',#ylim = c(0,10),
       # xlim=c(0,N_days),
       col='blue',lwd=2)
  
  polygon(c(summary_R_mob$mob,rev(summary_R_mob$mob)),
          (c(summary_R_mob$low[,i],rev(summary_R_mob$upper[,i]))),
          col=rgb(0,0,1,.2),border=NA)
  mtext(country[i], side = 3,  outer = FALSE,adj = -.15,font=2)
  
}

```



```{r, final}

for (i in 1:N_geo){
  niceplot(i)
  
}

```


when contained??

```{r}

contained <- data.frame(country = country,
                        median = rep(NA,N_geo),
                        low = rep(NA,N_geo),
                        up = rep(NA,N_geo))

for (i in 1:N_geo){
  
  contained$median[i] <- mean(summary_R_mob$mob[c(tail(which(summary_R_mob$median[ ,i]>1),1),
                                                  tail(which(summary_R_mob$median[ ,i]>1),1)+1)])
  contained$low[i] <- mean(summary_R_mob$mob[c(tail(which(summary_R_mob$low[ ,i]>1),1),
                                               tail(which(summary_R_mob$low[ ,i]>1),1)+1)])
  contained$up[i] <- mean(summary_R_mob$mob[c(tail(which(summary_R_mob$upper[ ,i]>1),1),
                                              tail(which(summary_R_mob$upper[ ,i]>1),1)+1)])
}

write.csv(x = contained,file = 'Rdata/results_contained.csv')

```